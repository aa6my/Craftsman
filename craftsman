#!/usr/bin/env php
<?php

/**
 * CLI Codeigniter Crafstman
 *
 * @author     David Sosa Valdes <https://gitlab.com/david-sosa-valdes>
 * @license    MIT License
 * @copyright  2015 David Sosa Valdes
 * @link       https://gitlab.com/david-sosa-valdes/craftsman
 * @copyright  Copyright (c) 2015, David Sosa Valdes.
 */

require 'vendor/autoload.php';
define('ROOTPATH',__DIR__.DIRECTORY_SEPARATOR);

use Symfony\Component\Console\Application;

use Codeigniter\Migrations\Generate as GenerateCommand;
use Codeigniter\Migrations\Run as RunCommand;
use Codeigniter\Migrations\Rollback as RollbackCommand;
use Codeigniter\Migrations\Refresh as RefreshCommand;
use Codeigniter\Migrations\Reset as ResetCommand;
use Codeigniter\Migrations\Info as InfoCommand;
use Codeigniter\Migrations\Version as VersionCommand;
use Codeigniter\Migrations\Latest as LatestCommand;

# Copy the CLI args 
$args = $_SERVER['argv'];

# Set empty args for the CI routing system
$_SERVER['argv'] = array();
# Replace CI's Migration Native Library
$CI = require ROOTPATH.'src/CiInstance.php';
$CI->load->add_package_path(ROOTPATH.'src/Extend');
$CI->config->load('migration', TRUE, TRUE);
$params = $CI->config->item('migration');
$CI->load->library('migration', $params);

# Pass the actual args to Symfony
$_SERVER['argv'] = $args;

# Migration Commands
$migration = array(
	new GenerateCommand(),
	new RunCommand($CI->migration),
	new RollbackCommand(),
	new ResetCommand(),
	new RefreshCommand(),
	new InfoCommand(),
	new VersionCommand(),
	new LatestCommand()
);
$application = new Application('Craftsman','2.0.3');

foreach ($migration as $key => $command) {
	$application->add($command);
}
$application->run();
